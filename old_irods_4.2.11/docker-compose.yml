version: '3.7' 
services:
  db:
    image: centos/postgresql-10-centos7
    container_name: irods_db_test
    restart: always
    expose:
      - 5432
    healthcheck:
      test: /usr/bin/pg_isready
      interval: 1s
      timeout: 10s
      retries: 120
    environment:
      POSTGRESQL_PASSWORD: "irods_pass"
      POSTGRESQL_USER: "irods"
      POSTGRESQL_DATABASE: "ICAT"
      
  irods:
    build: irods
    image: cyverse/irods-test:v4.2.11
    container_name: irods_test
    restart: always
    ports:
      - 1247:1247
    environment:
      POSTGRES_PASSWORD: "irods_pass"
      POSTGRES_USER: "irods"
      POSTGRES_DB: "ICAT"
      POSTGRES_HOSTNAME: "db"
      IRODS_ZONE: "test_zone"
      IRODS_ADMIN_USER: "rods"
      IRODS_ADMIN_PASSWORD: "irods_pass"
    links:
      - db
    tty: true

  
  irods:
    build:
      context: .
      dockerfile: irods/Dockerfile
      args:
        DB_NAME: "$DB_NAME"
        DB_USER: "$DB_USER"
        DB_PASSWORD: "$DB_PASSWORD"
        DBMS_HOST: "$DBMS_HOST"
        DBMS_PORT: "$DBMS_PORT"
        DBMS_TYPE: "$DBMS_TYPE"
        IRODS_CONTROL_PLANE_KEY: "$IRODS_CONTROL_PLANE_KEY"
        IRODS_CONTROL_PLANE_PORT: "$IRODS_CONTROL_PLANE_PORT"
        IRODS_DEFAULT_RESOURCE: "$IRODS_DEFAULT_RESOURCE"
        IRODS_FIRST_EPHEMERAL_PORT: "$IRODS_FIRST_EPHEMERAL_PORT"
        IRODS_LAST_EPHEMERAL_PORT: "$IRODS_LAST_EPHEMERAL_PORT"
        IRODS_HOST: "$IRODS_CONF_HOST"
        IRODS_NEGOTIATION_KEY: "$IRODS_NEGOTIATION_KEY"
        IRODS_SCHEMA_VALIDATION: "$IRODS_SCHEMA_VALIDATION"
        IRODS_SYSTEM_GROUP: "$IRODS_SYSTEM_GROUP"
        IRODS_SYSTEM_USER: "$IRODS_SYSTEM_USER"
        IRODS_ZONE_NAME: "$IRODS_ZONE_NAME"
        IRODS_ZONE_KEY: "$IRODS_ZONE_KEY"
        IRODS_ZONE_PORT: "$IRODS_ZONE_PORT"
        IRODS_ADMIN_USER: "$IRODS_ADMIN_USER"
        IRODS_ADMIN_PASSWORD: "$IRODS_ADMIN_PASSWORD"
        IRODS_MAX_NUM_RE_PROCS: "$IRODS_MAX_NUM_RE_PROCS"
        NATS_URL: "$NATS_URL"
        NATS_CLUSTER_ID: "$NATS_CLUSTER_ID"
        NATS_CLIENT_ID: "$NATS_CLIENT_ID"
        IRODS_MOUNT_PATH: "$IRODS_MOUNT_PATH"
        IRODS_BISQUE_ADMIN_USER: "$IRODS_BISQUE_ADMIN_USER"
        BISQUE_HOST: "$BISQUE_HOST"
        BISQUE_ADMIN_USER: "$BISQUE_ADMIN_USER"
        BISQUE_ADMIN_PASSWORD: "$BISQUE_ADMIN_PASSWORD"
    hostname: "$IRODS_CONF_HOST"
    ports:
      - "1247:1247"
      - "$IRODS_FIRST_EPHEMERAL_PORT-$IRODS_LAST_EPHEMERAL_PORT:$IRODS_FIRST_EPHEMERAL_PORT-$IRODS_LAST_EPHEMERAL_PORT"
    volumes:
      - "irods_volume:$IRODS_VAULT"
    depends_on:
      - dbms
      - nats


volumes:
  db_volume:
  irods_volume:
    